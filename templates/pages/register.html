{% extends "layouts/base.html" %}

{% block title %}Register - Requirements Generator{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md" data-testid="register-header">
        <div class="flex justify-center">
            <div class="w-16 h-16 bg-brand-600 rounded-xl flex items-center justify-center">
                <i data-lucide="layers" class="w-10 h-10 text-white"></i>
            </div>
        </div>
        <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">
            Create your account
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
            {% if invitation_data %}
                You've been invited to join {{ invitation_data.tenant_id }}
            {% else %}
                Join the Requirements Generator platform
            {% endif %}
        </p>
    </div>

    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md" data-testid="register-form-container">
        <div class="bg-white py-8 px-4 shadow-lg sm:rounded-lg sm:px-10">
            {% if invitation_data %}
            <!-- Invitation Info -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i data-lucide="mail" class="h-5 w-5 text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">You're invited!</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Role: <span class="font-medium">{{ invitation_data.role.replace('_', ' ').title() }}</span></p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Registration Form -->
            <form id="register-form" hx-post="/api/auth/register" hx-swap="none" hx-disabled-elt="#register-button" class="space-y-6">
                {% if invitation_token %}
                <input type="hidden" name="invitation_token" value="{{ invitation_token }}">
                {% endif %}

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium leading-6 text-gray-900">
                            First name
                        </label>
                        <div class="mt-2">
                            <input id="first_name"
                                   name="first_name"
                                   type="text"
                                   autocomplete="given-name"
                                   required
                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-600 sm:text-sm sm:leading-6"
                                   placeholder="John">
                        </div>
                    </div>

                    <div>
                        <label for="last_name" class="block text-sm font-medium leading-6 text-gray-900">
                            Last name
                        </label>
                        <div class="mt-2">
                            <input id="last_name"
                                   name="last_name"
                                   type="text"
                                   autocomplete="family-name"
                                   required
                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-600 sm:text-sm sm:leading-6"
                                   placeholder="Doe">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium leading-6 text-gray-900">
                        Email address
                    </label>
                    <div class="mt-2">
                        <input id="email"
                               name="email"
                               type="email"
                               autocomplete="email"
                               required
                               {% if invitation_data %}value="{{ invitation_data.email }}" readonly{% endif %}
                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-600 sm:text-sm sm:leading-6 {% if invitation_data %}bg-gray-50{% endif %}"
                               placeholder="john@example.com">
                    </div>
                </div>

                <div>
                    <label for="username" class="block text-sm font-medium leading-6 text-gray-900">
                        Username <span class="text-gray-500">(optional)</span>
                    </label>
                    <div class="mt-2">
                        <input id="username"
                               name="username"
                               type="text"
                               autocomplete="username"
                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-600 sm:text-sm sm:leading-6"
                               placeholder="johndoe">
                    </div>
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium leading-6 text-gray-900">
                        Password
                    </label>
                    <div class="mt-2 relative">
                        <input id="password"
                               name="password"
                               type="password"
                               autocomplete="new-password"
                               required
                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-600 sm:text-sm sm:leading-6"
                               placeholder="Create a strong password">
                        <button type="button"
                                onclick="togglePassword('password')"
                                class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i data-lucide="eye" class="h-4 w-4 text-gray-400" id="password-toggle-icon"></i>
                        </button>
                    </div>
                    <div class="mt-1">
                        <div id="password-strength" class="text-xs text-gray-500">
                            Password must contain at least 8 characters with uppercase, lowercase, and number
                        </div>
                    </div>
                </div>

                <div>
                    <label for="confirm_password" class="block text-sm font-medium leading-6 text-gray-900">
                        Confirm password
                    </label>
                    <div class="mt-2 relative">
                        <input id="confirm_password"
                               name="confirm_password"
                               type="password"
                               autocomplete="new-password"
                               required
                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-600 sm:text-sm sm:leading-6"
                               placeholder="Confirm your password">
                        <button type="button"
                                onclick="togglePassword('confirm_password')"
                                class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i data-lucide="eye" class="h-4 w-4 text-gray-400" id="confirm-password-toggle-icon"></i>
                        </button>
                    </div>
                    <div id="password-match" class="mt-1 text-xs text-gray-500"></div>
                </div>

                <div class="flex items-center">
                    <input id="terms" name="terms" type="checkbox" required
                           class="h-4 w-4 rounded border-gray-300 text-brand-600 focus:ring-brand-600">
                    <label for="terms" class="ml-3 block text-sm leading-6 text-gray-900">
                        I agree to the
                        <a href="#" class="font-semibold text-brand-600 hover:text-brand-500">Terms of Service</a>
                        and
                        <a href="#" class="font-semibold text-brand-600 hover:text-brand-500">Privacy Policy</a>
                    </label>
                </div>

                <div>
                    <button type="submit"
                            class="flex w-full justify-center rounded-md bg-brand-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-brand-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-600 disabled:opacity-50 disabled:cursor-not-allowed"
                            id="register-button">
                        <span class="flex items-center">
                            <span id="register-text">Create account</span>
                            <div id="register-spinner" class="hidden ml-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            </div>
                        </span>
                    </button>
                </div>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm leading-6">
                        <span class="bg-white px-6 text-gray-500">Already have an account?</span>
                    </div>
                </div>

                <div class="mt-6">
                    <a href="/login"
                       class="flex w-full justify-center rounded-md bg-white px-3 py-1.5 text-sm font-semibold text-brand-600 shadow-sm ring-1 ring-inset ring-brand-600 hover:bg-brand-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-600">
                        Sign in instead
                    </a>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>
    </div>
</div>

<script>
function togglePassword(inputId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = document.getElementById(inputId + '-toggle-icon');

    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.setAttribute('data-lucide', 'eye-off');
    } else {
        passwordInput.type = 'password';
        toggleIcon.setAttribute('data-lucide', 'eye');
    }
    lucide.createIcons();
}

function validatePassword() {
    const password = document.getElementById('password').value;
    const strengthDiv = document.getElementById('password-strength');

    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasLength = password.length >= 8;

    if (password === '') {
        strengthDiv.textContent = 'Password must contain at least 8 characters with uppercase, lowercase, and number';
        strengthDiv.className = 'text-xs text-gray-500';
        return false;
    }

    if (hasLength && hasUpper && hasLower && hasNumber) {
        strengthDiv.textContent = 'Strong password';
        strengthDiv.className = 'text-xs text-green-600';
        return true;
    } else {
        const missing = [];
        if (!hasLength) missing.push('8 characters');
        if (!hasUpper) missing.push('uppercase letter');
        if (!hasLower) missing.push('lowercase letter');
        if (!hasNumber) missing.push('number');

        strengthDiv.textContent = `Missing: ${missing.join(', ')}`;
        strengthDiv.className = 'text-xs text-red-600';
        return false;
    }
}

function validatePasswordMatch() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchDiv = document.getElementById('password-match');

    if (confirmPassword === '') {
        matchDiv.textContent = '';
        return false;
    }

    if (password === confirmPassword) {
        matchDiv.textContent = 'Passwords match';
        matchDiv.className = 'mt-1 text-xs text-green-600';
        return true;
    } else {
        matchDiv.textContent = 'Passwords do not match';
        matchDiv.className = 'mt-1 text-xs text-red-600';
        return false;
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 ease-in-out ${
        type === 'error' ? 'border-l-4 border-red-500' :
        type === 'success' ? 'border-l-4 border-green-500' :
        'border-l-4 border-blue-500'
    }`;

    toast.innerHTML = `
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    ${type === 'error' ?
                        '<i data-lucide="alert-circle" class="h-5 w-5 text-red-400"></i>' :
                        type === 'success' ?
                        '<i data-lucide="check-circle" class="h-5 w-5 text-green-400"></i>' :
                        '<i data-lucide="info" class="h-5 w-5 text-blue-400"></i>'
                    }
                </div>
                <div class="ml-3 w-0 flex-1 pt-0.5">
                    <p class="text-sm font-medium text-gray-900">${message}</p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button onclick="this.closest('.max-w-sm').remove()" class="rounded-md inline-flex text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('toast-container').appendChild(toast);
    lucide.createIcons();

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Event listeners
document.getElementById('password').addEventListener('input', validatePassword);
document.getElementById('confirm_password').addEventListener('input', validatePasswordMatch);

// Handle registration form submission
document.getElementById('register-form').addEventListener('htmx:beforeRequest', function(event) {
    const button = document.getElementById('register-button');
    const text = document.getElementById('register-text');
    const spinner = document.getElementById('register-spinner');

    // Validate form before submission
    if (!validatePassword() || !validatePasswordMatch()) {
        event.preventDefault();
        showToast('Please fix the password issues before continuing', 'error');
        return;
    }

    button.disabled = true;
    text.textContent = 'Creating account...';
    spinner.classList.remove('hidden');
});

document.getElementById('register-form').addEventListener('htmx:afterRequest', function(event) {
    const button = document.getElementById('register-button');
    const text = document.getElementById('register-text');
    const spinner = document.getElementById('register-spinner');

    button.disabled = false;
    text.textContent = 'Create account';
    spinner.classList.add('hidden');

    if (event.detail.xhr.status === 201) {
        const response = JSON.parse(event.detail.xhr.responseText);
        showToast('Account created successfully! Please sign in.', 'success');

        setTimeout(() => {
            window.location.href = '/login';
        }, 2000);
    } else {
        const response = JSON.parse(event.detail.xhr.responseText);
        showToast(response.detail || 'Registration failed. Please try again.', 'error');
    }
});

// Initialize Lucide icons
lucide.createIcons();
</script>
{% endblock %}